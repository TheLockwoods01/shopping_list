<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lockwood Shop</title>
    
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        :root {
            --primary: #004e98;
            --accent: #f37a1f;
            --green: #28a745;
            --bg: #f2f2f7;
            --text: #1c1c1e;
            --border: #e5e5ea;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Header --- */
        header {
            background: white; padding: 15px 20px;
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid #ccc;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        h1 { margin: 0; font-size: 1.3rem; color: var(--primary); font-weight: 800; }
        .header-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0 10px;
        }

        /* --- Inputs --- */
        .add-zone {
            padding: 10px 15px; background: white; border-bottom: 1px solid var(--border);
            display: flex; gap: 10px; align-items: center;
        }
        input, select, textarea {
            padding: 12px; border: 1px solid #c7c7cc; border-radius: 8px;
            font-size: 1rem; background: #fff; width: 100%; box-sizing: border-box; font-family: inherit;
        }
        .btn-add {
            background: var(--green); color: white; border: none; border-radius: 8px;
            padding: 0 20px; font-weight: bold; height: 44px; white-space: nowrap;
        }

        /* --- Custom Search Suggestions --- */
        .suggestions-box {
            background: white; border: 1px solid #ccc; border-radius: 8px;
            max-height: 200px; overflow-y: auto; margin-top: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .suggestion-item {
            padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 1rem; color: #333;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background: #f0f0f0; }

        /* --- Search Bar --- */
        .search-box {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 8px;
            font-size: 1rem; background: #f9f9f9;
        }

        /* --- Cards & Lists --- */
        .content-area { padding: 15px; }
        
        .aisle-card {
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 25px; border: 1px solid #e0e0e0;
        }
        .aisle-header {
            background: #f8f9fa; padding: 12px 15px;
            font-size: 0.85rem; font-weight: 900; color: #444;
            text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        /* --- Item Rows --- */
        .item-row {
            padding: 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; background: white;
        }
        .item-row:last-child { border-bottom: none; }
        .item-row.is-done { background: #f9fdf9; }
        .item-row.is-done .item-name { color: #aaa; text-decoration: line-through; }
        .item-info { flex-grow: 1; padding-right: 10px; }
        .item-name { font-size: 1.1rem; line-height: 1.3; display: block; color: #333; }

        /* --- Recipe Styling --- */
        .section-label {
            font-size: 0.9rem; font-weight: 800; color: #8e8e93; text-transform: uppercase; 
            margin: 20px 0 10px 5px; letter-spacing: 1px;
        }
        
        /* Menu Board Cards */
        .menu-card {
            background: #e3f2fd; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            border: 1px solid #bbdefb; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        .menu-title { font-weight: bold; color: #0d47a1; font-size: 1rem; }
        .btn-remove-menu {
            background: #fff; border: 1px solid #90caf9; color: #d32f2f;
            width: 32px; height: 32px; border-radius: 50%; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            z-index: 5; 
        }

        /* Standard Recipe Cards */
        .recipe-card {
            background: white; border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        .recipe-header {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            background: #fff; border-bottom: 1px solid #eee; cursor: pointer;
        }
        .recipe-info { display: flex; flex-direction: column; }
        .recipe-title { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .recipe-date { font-size: 0.8rem; color: #999; margin-top: 3px; }
        
        .recipe-body { padding: 15px; display: none; background: #fcfcfc; }
        .recipe-body.open { display: block; }
        .ing-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .ing-row input[type="checkbox"] { width: 24px; height: 24px; margin-right: 15px; }
        .btn-recipe-add { 
            width: 100%; padding: 12px; margin-top: 15px;
            background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem;
        }
        
        /* Badges */
        .in-cart-badge {
            background: #e8f5e9; color: #2e7d32; font-size: 0.75rem; font-weight: 800;
            padding: 3px 8px; border-radius: 10px; margin-left: 10px; letter-spacing: 0.5px;
        }

        /* Recipe Qty Editing */
        .rec-edit-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #eee;
        }
        .qty-control {
            display: flex; align-items: center; gap: 8px; background: #f0f0f5; padding: 2px; border-radius: 8px;
        }
        .btn-mini {
            width: 28px; height: 28px; border: none; background: white; border-radius: 6px;
            font-weight: bold; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- Buttons --- */
        .btn-circle-sains {
            width: 44px; height: 44px; border-radius: 50%;
            border: 2px solid var(--accent); background: white; color: var(--accent);
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; font-weight: bold; margin-right: 8px; flex-shrink: 0;
        }
        .btn-undo {
            width: 44px; height: 44px; border-radius: 50%;
            border: 2px solid #999; background: white; color: #999;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; margin-right: 8px; flex-shrink: 0;
        }
        .btn-pill {
            background: white; border: 2px solid #ccc; color: #999;
            border-radius: 20px; min-width: 80px; padding: 0 15px; height: 44px;
            font-weight: bold; font-size: 0.95rem; flex-shrink: 0;
        }
        .btn-pill.active {
            background: var(--green); border-color: var(--green); color: white;
            box-shadow: 0 2px 5px rgba(40, 167, 69, 0.3);
        }

        /* Qty Badge */
        .qty-badge {
            background: #eee; color: #555; min-width: 28px; height: 28px;
            border-radius: 14px; display: inline-flex; align-items: center; justify-content: center;
            font-size: 0.9rem; font-weight: bold; margin-right: 12px;
        }
        .active .qty-badge { background: var(--primary); color: white; }

        /* --- Nav --- */
        nav {
            position: fixed; bottom: 0; width: 100%;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #ccc; display: flex; height: 75px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border: none; background: none; color: #999; font-size: 0.75rem; font-weight: 600;
        }
        .nav-item span { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }

        /* --- Modal --- */
        .modal-bg {
            display: none; position: fixed; z-index: 1000;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal {
            background: white; width: 85%; max-width: 400px;
            border-radius: 16px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 80vh; overflow-y: auto;
        }
        .modal h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;}
        .form-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .label { display: block; font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 5px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 25px; }
        .btn-full { flex: 1; padding: 14px; border-radius: 8px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        
        .hidden { display: none; }
        .empty-msg { text-align: center; color: #999; margin-top: 40px; font-style: italic; font-size: 1.1rem; }
    </style>
</head>
<body>

<header>
    <h1 id="header-title">Plan List</h1>
    <button class="header-btn" onclick="openSettings()">‚öôÔ∏è</button>
</header>

<div id="page-kitchen" class="page">
    <div class="add-zone">
        <input type="text" id="newInput" style="flex-grow:1;" placeholder="Add new item...">
        <button class="btn-add" onclick="addItem()">Add</button>
    </div>
    <div class="content-area">
        <input type="text" id="search-bar" class="search-box" placeholder="üîç Search kitchen items..." onkeyup="renderKitchen()">
        <div id="list-kitchen"></div>
    </div>
</div>

<div id="page-recipes" class="page hidden">
    <div class="add-zone">
        <input type="text" id="newRecipeInput" style="flex-grow:1;" placeholder="New Recipe Name...">
        <button class="btn-add" onclick="createRecipe()">Create</button>
    </div>
    <div class="content-area">
        <div id="menu-section" class="hidden">
            <div class="section-label">üìÖ On The Menu (Tap to View)</div>
            <div id="list-menu"></div>
        </div>

        <div class="section-label" style="margin-top:20px;">üìö Recipe Book</div>
        <div id="list-recipes"></div>
    </div>
</div>

<div id="page-aldi" class="page hidden">
    <div class="content-area" id="list-aldi"></div>
</div>

<div id="page-sains" class="page hidden">
    <div class="content-area" id="list-sains"></div>
</div>

<nav>
    <button class="nav-item active" onclick="go('kitchen')"><span>üè†</span> Kitchen</button>
    <button class="nav-item" onclick="go('recipes')"><span>üë®‚Äçüç≥</span> Chef</button>
    <button class="nav-item" onclick="go('aldi')"><span>üõí</span> Aldi</button>
    <button class="nav-item" onclick="go('sains')"><span>üçä</span> Sains</button>
</nav>

<div id="modal-overlay" class="modal-bg">
    <div class="modal">
        <h2>Edit Item</h2>
        <input type="hidden" id="edit-id">
        <div style="margin-bottom:15px;">
            <label class="label">Item Name</label>
            <input type="text" id="edit-name">
        </div>
        <div class="form-row">
            <div style="flex:1">
                <label class="label">Aisle (1-99)</label>
                <input type="number" id="edit-aisle">
            </div>
            <div style="flex:1">
                <label class="label">Side</label>
                <select id="edit-side">
                    <option value="A">A (Start)</option>
                    <option value="B">B (End)</option>
                </select>
            </div>
        </div>
        <div style="margin-bottom:15px;">
            <label class="label">Order (1-100)</label>
            <input type="number" id="edit-order">
        </div>
        <div class="modal-btns">
            <button class="btn-full" style="background:#ffebee; color:#d32f2f;" onclick="deleteItem()">Delete</button>
            <button class="btn-full" style="background:#eee; color:#333;" onclick="closeModal()">Cancel</button>
            <button class="btn-full" style="background:var(--primary); color:white;" onclick="saveEdit()">Save</button>
        </div>
    </div>
</div>

<div id="modal-recipe" class="modal-bg">
    <div class="modal">
        <h2>Edit Recipe</h2>
        <input type="hidden" id="rec-id">
        <div style="margin-bottom:15px;">
            <label class="label">Recipe Name</label>
            <input type="text" id="rec-name">
        </div>
        <div style="margin-bottom:15px; position:relative;">
            <label class="label">Add Ingredient</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="rec-new-ing" style="flex:1;" placeholder="Type to search..." oninput="showSuggestions(this.value)">
                <button class="btn-add" onclick="addIngredientToRecipe()">+</button>
            </div>
            <div id="suggestion-box" class="suggestions-box"></div>
        </div>
        <div id="rec-ing-list" style="max-height:250px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:5px; margin-bottom:15px;"></div>
        <div class="modal-btns">
            <button class="btn-full" style="background:#ffebee; color:#d32f2f;" onclick="deleteRecipe()">Delete Recipe</button>
            <button class="btn-full" style="background:#eee; color:#333;" onclick="closeRecModal()">Done</button>
        </div>
    </div>
</div>

<div id="modal-menu-details" class="modal-bg">
    <div class="modal">
        <h2 id="menu-details-title">Menu Details</h2>
        <input type="hidden" id="menu-details-id">
        
        <div class="label" style="color:var(--green);">‚úÖ Added to Plan:</div>
        <div id="menu-included-list" style="margin-bottom:20px; font-size:0.9rem; color:#333; line-height:1.5;"></div>

        <div class="label" style="color:#d32f2f;">‚ùå Left Behind (Add now?):</div>
        <div id="menu-excluded-list" style="margin-bottom:10px; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:5px;"></div>

        <div class="modal-btns">
            <button class="btn-full" style="background:#eee; color:#333;" onclick="closeMenuDetails()">Close</button>
            <button class="btn-full" style="background:var(--primary); color:white;" onclick="addMissingItems()">Update Plan</button>
        </div>
    </div>
</div>

<div id="modal-settings" class="modal-bg">
    <div class="modal">
        <h2>‚öôÔ∏è Settings</h2>
        
        <div id="settings-main">
            <label class="label">Manage Data</label>
            <button class="btn-full" style="background:var(--primary); color:white; margin-bottom:10px;" onclick="exportData()">üíæ Backup Data (Copy)</button>
            <button class="btn-full" style="background:#eee; color:#333; margin-bottom:20px;" onclick="showRestoreUI()">üì• Restore Data (Paste)</button>

            <label class="label">Shop Actions</label>
            <button class="btn-full" style="background:#fff8e1; color:#f57c00; margin-bottom:10px;" onclick="resetMenu()">üìÖ Clear "On The Menu"</button>
            <button class="btn-full" style="background:#ffebee; color:#d32f2f; margin-bottom:10px;" onclick="resetAll()">üîÑ Reset Quantities (0)</button>
            
            <div class="modal-btns">
                <button class="btn-full" style="background:#eee; color:#333;" onclick="closeSettings()">Close</button>
            </div>
        </div>

        <div id="settings-restore" class="hidden">
            <label class="label">Paste Backup Code Here:</label>
            <textarea id="restore-input" rows="10" placeholder="{...}" style="width:100%; font-family:monospace; font-size:0.8rem; margin-bottom:10px;"></textarea>
            <div class="modal-btns">
                <button class="btn-full" style="background:#eee; color:#333;" onclick="hideRestoreUI()">Cancel</button>
                <button class="btn-full" style="background:var(--green); color:white;" onclick="confirmRestore()">Load Data</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATA ---
    let items = JSON.parse(localStorage.getItem('shopMaster_v1')) || [];
    let recipes = JSON.parse(localStorage.getItem('shopRecipes_v1')) || [];

    // MIGRATION V5.0: Convert old "Array of Strings" to "Array of Objects"
    function migrateData() {
        let changed = false;
        recipes.forEach(r => {
            if (r.ingredients.length > 0 && typeof r.ingredients[0] === 'string') {
                r.ingredients = r.ingredients.map(name => ({ name: name, qty: 1 }));
                changed = true;
            }
        });
        if(changed) saveRecipes();
    }
    migrateData(); 

    function save() { localStorage.setItem('shopMaster_v1', JSON.stringify(items)); render(); }
    function saveRecipes() { localStorage.setItem('shopRecipes_v1', JSON.stringify(recipes)); renderRecipes(); }

    // --- NAVIGATION ---
    let tab = 'kitchen';
    function go(newTab) {
        tab = newTab;
        document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
        document.getElementById('page-' + tab).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navs = document.querySelectorAll('.nav-item');
        if(tab === 'kitchen') navs[0].classList.add('active');
        if(tab === 'recipes') navs[1].classList.add('active');
        if(tab === 'aldi') navs[2].classList.add('active');
        if(tab === 'sains') navs[3].classList.add('active');
        const titles = { 'kitchen': 'Kitchen Plan', 'recipes': 'Recipes', 'aldi': 'Aldi Mission', 'sains': 'Sainsbury\'s' };
        document.getElementById('header-title').innerText = titles[tab];
        render();
    }

    // --- KITCHEN ACTIONS ---
    function addItem() {
        const txt = document.getElementById('newInput').value.trim();
        if(!txt) return;
        const exists = items.find(i => i.name.toLowerCase() === txt.toLowerCase());
        if(exists) { alert("Item already exists!"); return; }
        items.push({ id: Date.now(), name: txt, aisle: 99, side: 'A', order: 50, qty: 1, status: 'active' });
        document.getElementById('newInput').value = '';
        save();
    }
    function toggleQty(id) {
        const i = items.find(x => x.id === id);
        i.qty = (i.qty + 1) % 4; 
        if(i.qty > 0 && i.status === 'idle') i.status = 'active'; 
        if(i.qty === 0) i.status = 'idle'; 
        save();
    }
    function resetAll() {
        if(confirm('Start fresh? (Resets all quantities to 0)')) {
            items.forEach(i => { i.qty = 0; i.status = 'idle'; });
            save();
            closeSettings();
        }
    }
    function resetMenu() {
        if(confirm('Clear the Menu Board? (Recipes stay in book)')) {
            recipes.forEach(r => { r.inMenu = false; r.activeIngredients = []; });
            saveRecipes();
            closeSettings();
        }
    }

    // --- RECIPE ACTIONS ---
    function createRecipe() {
        const name = document.getElementById('newRecipeInput').value.trim();
        if(!name) return;
        recipes.push({ id: Date.now(), name: name, ingredients: [], inMenu: false, lastDate: '', activeIngredients: [] });
        document.getElementById('newRecipeInput').value = '';
        saveRecipes();
    }
    function toggleRecipeView(id) {
        document.getElementById('rec-body-'+id).classList.toggle('open');
    }
    
    function removeFromMenu(id) {
        const r = recipes.find(x => x.id === id);
        r.inMenu = false;
        r.activeIngredients = []; // Clear memory
        saveRecipes();
    }

    // NEW: Open Menu Details Modal
    function openMenuDetails(id) {
        const r = recipes.find(x => x.id === id);
        document.getElementById('menu-details-title').innerText = r.name;
        document.getElementById('menu-details-id').value = id;

        // Determine what is active (Fallback for old data: assume all)
        const activeList = r.activeIngredients || r.ingredients.map(i => i.name);
        
        // Render Included
        const includedDiv = document.getElementById('menu-included-list');
        if(activeList.length === 0) includedDiv.innerHTML = "<i>Nothing selected.</i>";
        else includedDiv.innerHTML = activeList.map(name => `‚Ä¢ ${name}`).join('<br>');

        // Render Excluded (Ingredients NOT in activeList)
        const excludedDiv = document.getElementById('menu-excluded-list');
        const excluded = r.ingredients.filter(i => !activeList.includes(i.name));

        if(excluded.length === 0) {
            excludedDiv.innerHTML = "<i>All items added!</i>";
        } else {
            excludedDiv.innerHTML = excluded.map(ing => `
                <div style="padding:5px; border-bottom:1px solid #eee;">
                    <input type="checkbox" class="missing-item-check" value="${ing.name}"> 
                    ${ing.name}
                </div>
            `).join('');
        }

        document.getElementById('modal-menu-details').style.display = 'flex';
    }

    function closeMenuDetails() { document.getElementById('modal-menu-details').style.display = 'none'; }

    // NEW: Add Missing Items from Details Modal
    function addMissingItems() {
        const id = parseInt(document.getElementById('menu-details-id').value);
        const r = recipes.find(x => x.id === id);
        const checks = document.querySelectorAll('.missing-item-check:checked');
        
        if(checks.length === 0) { closeMenuDetails(); return; }

        let count = 0;
        // Ensure activeIngredients exists
        if(!r.activeIngredients) r.activeIngredients = [];

        checks.forEach(box => {
            const ingName = box.value;
            // Add to active memory
            r.activeIngredients.push(ingName);

            // Add to Shopping List
            const recIng = r.ingredients.find(ri => ri.name === ingName);
            const qtyToAdd = recIng ? recIng.qty : 1;

            let item = items.find(i => i.name.toLowerCase() === ingName.toLowerCase());
            if(item) {
                item.qty = (item.qty || 0) + qtyToAdd;
                if(item.status === 'idle' || item.status === 'done_aldi' || item.status === 'done_sains') {
                    item.status = 'active';
                }
            } else {
                items.push({ id: Date.now() + Math.random(), name: ingName, aisle: 99, side: 'A', order: 50, qty: qtyToAdd, status: 'active' });
            }
            count++;
        });

        save(); saveRecipes();
        alert(`Updated! Added ${count} items.`);
        closeMenuDetails();
    }


    // NEW ADD TO PLAN (Saves Active Snapshot)
    function addRecipeToPlan(id) {
        const rec = recipes.find(r => r.id === id);
        const checkboxes = document.querySelectorAll(`.rec-check-${id}:checked`);
        let count = 0;
        let activeSnapshot = []; // To store what we picked

        checkboxes.forEach(box => {
            const ingName = box.value;
            activeSnapshot.push(ingName); // Save name to snapshot

            // Find the qty from the recipe data
            const recIng = rec.ingredients.find(ri => ri.name === ingName);
            const qtyToAdd = recIng ? recIng.qty : 1;

            let item = items.find(i => i.name.toLowerCase() === ingName.toLowerCase());
            if(item) {
                item.qty = (item.qty || 0) + qtyToAdd;
                if(item.status === 'idle' || item.status === 'done_aldi' || item.status === 'done_sains') {
                    item.status = 'active';
                }
            } else {
                items.push({ id: Date.now() + Math.random(), name: ingName, aisle: 99, side: 'A', order: 50, qty: qtyToAdd, status: 'active' });
            }
            count++;
        });

        rec.inMenu = true;
        rec.activeIngredients = activeSnapshot; // SAVE THE SNAPSHOT
        rec.lastDate = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

        save(); saveRecipes();
        alert(`Added to Menu Plan!\n(${count} ingredients added)`);
        toggleRecipeView(id); renderRecipes();
    }

    // --- ALDI/SAINS ACTIONS ---
    function toggleAldiDone(id) {
        const i = items.find(x => x.id === id);
        if(i.status === 'active') i.status = 'done_aldi';
        else if(i.status === 'done_aldi') i.status = 'active'; 
        save();
    }
    function moveToSains(id) {
        const i = items.find(x => x.id === id);
        i.status = 'sains';
        save();
    }
    function toggleSainsDone(id) {
        const i = items.find(x => x.id === id);
        if(i.status === 'sains') i.status = 'done_sains';
        else if(i.status === 'done_sains') i.status = 'sains'; 
        save();
    }
    function revertToAldi(id) {
        const i = items.find(x => x.id === id);
        i.status = 'active'; 
        save();
    }

    // --- SETTINGS ---
    function openSettings() { document.getElementById('modal-settings').style.display = 'flex'; hideRestoreUI(); }
    function closeSettings() { document.getElementById('modal-settings').style.display = 'none'; }
    function exportData() {
        const data = { items: items, recipes: recipes };
        const json = JSON.stringify(data);
        navigator.clipboard.writeText(json).then(() => { alert("Data copied! Paste into a Note."); });
    }
    function showRestoreUI() {
        document.getElementById('settings-main').style.display = 'none';
        document.getElementById('settings-restore').classList.remove('hidden');
        document.getElementById('restore-input').value = ''; 
        document.getElementById('settings-restore').style.display = 'block'; 
    }
    function hideRestoreUI() {
        document.getElementById('settings-restore').style.display = 'none';
        document.getElementById('settings-main').style.display = 'block';
    }
    function confirmRestore() {
        const json = document.getElementById('restore-input').value.trim();
        if(!json) return;
        try {
            const data = JSON.parse(json);
            if(data.items && data.recipes) {
                items = data.items;
                recipes = data.recipes;
                migrateData(); 
                save(); saveRecipes();
                alert("Restore successful!");
                hideRestoreUI(); closeSettings(); go(tab);
            } else { alert("Invalid code structure."); }
        } catch(e) { alert("Error reading code: " + e.message); }
    }

    // --- RENDERERS ---
    function render() {
        if(tab === 'kitchen') renderKitchen();
        if(tab === 'recipes') renderRecipes();
        if(tab === 'aldi') renderAldi();
        if(tab === 'sains') renderSains();
    }
    function renderKitchen() {
        const search = document.getElementById('search-bar').value.toLowerCase();
        const sorted = [...items].sort((a,b) => a.name.localeCompare(b.name));
        const filtered = sorted.filter(i => i.name.toLowerCase().includes(search));
        const html = filtered.map(i => `
            <div class="item-row ${i.qty > 0 ? 'active' : 'inactive'}" style="border-bottom:1px solid #eee;" onclick="toggleQty(${i.id})">
                <span class="qty-badge">${i.qty}</span>
                <span class="item-name">${i.name}</span>
            </div>
        `).join('');
        document.getElementById('list-kitchen').innerHTML = `<div class="aisle-card">${html}</div>`;
    }

    function renderRecipes() {
        // 1. RENDER MENU BOARD
        const menuItems = recipes.filter(r => r.inMenu);
        const menuDiv = document.getElementById('list-menu');
        const menuSection = document.getElementById('menu-section');
        
        if(menuItems.length > 0) {
            menuSection.classList.remove('hidden');
            menuDiv.innerHTML = menuItems.map(r => `
                <div class="menu-card" onclick="openMenuDetails(${r.id})">
                    <span class="menu-title">${r.name}</span>
                    <button class="btn-remove-menu" onclick="event.stopPropagation(); removeFromMenu(${r.id})">‚úï</button>
                </div>
            `).join('');
        } else {
            menuSection.classList.add('hidden');
        }

        // 2. RENDER RECIPE BOOK
        const div = document.getElementById('list-recipes');
        if(recipes.length === 0) { div.innerHTML = '<div class="empty-msg">No recipes yet.</div>'; return; }
        
        const sortedRecipes = [...recipes].sort((a,b) => a.name.localeCompare(b.name));

        div.innerHTML = sortedRecipes.map(r => {
            const sortedIngs = [...r.ingredients].sort((a,b) => a.name.localeCompare(b.name));
            
            return `
            <div class="recipe-card">
                <div class="recipe-header" onclick="toggleRecipeView(${r.id})">
                    <div class="recipe-info">
                        <span class="recipe-title">${r.name}</span>
                        ${r.lastDate ? `<span class="recipe-date">Last: ${r.lastDate}</span>` : ''}
                    </div>
                    <button class="btn-add" style="padding:5px 10px; height:auto; font-size:0.8rem;" onclick="event.stopPropagation(); openRecModal(${r.id})">Edit</button>
                </div>
                <div id="rec-body-${r.id}" class="recipe-body">
                    ${sortedIngs.map(ing => {
                        const kitchenItem = items.find(i => i.name === ing.name);
                        const inCart = (kitchenItem && kitchenItem.qty > 0);
                        
                        return `
                        <div class="ing-row">
                            <input type="checkbox" class="rec-check-${r.id}" value="${ing.name}" checked>
                            <span>${ing.name} ${ing.qty > 1 ? `(x${ing.qty})` : ''}</span>
                            ${inCart ? `<span class="in-cart-badge">IN CART</span>` : ''}
                        </div>
                    `}).join('')}
                    ${r.ingredients.length > 0 ? `<button class="btn-recipe-add" onclick="addRecipeToPlan(${r.id})">Add to Plan</button>` : ''}
                </div>
            </div>
        `}).join('');
    }

    function renderAldi() {
        const needed = items.filter(i => (i.status === 'active' || i.status === 'done_aldi') && i.qty > 0);
        if(!needed.length) { document.getElementById('list-aldi').innerHTML = '<div class="empty-msg">List is empty.</div>'; return; }
        needed.sort((a,b) => {
            if(a.aisle !== b.aisle) return a.aisle - b.aisle;
            if(a.side !== b.side) return a.side.localeCompare(b.side);
            return a.order - b.order;
        });
        let html = ''; let currentAisleKey = ''; let itemsInGroup = [];
        const flushGroup = () => {
            if(itemsInGroup.length === 0) return;
            const example = itemsInGroup[0];
            const headerText = example.aisle === 99 ? "Unsorted" : `Aisle ${example.aisle} ‚Ä¢ Side ${example.side}`;
            html += `<div class="aisle-card"><div class="aisle-header">${headerText}</div>`;
            itemsInGroup.forEach(i => {
                const isDone = (i.status === 'done_aldi');
                html += `
                <div class="item-row ${isDone ? 'is-done' : ''}">
                    <div class="item-info" onclick="openEdit(${i.id})">
                        <div class="item-name"><span style="color:var(--primary); font-weight:bold;">(${i.qty})</span> ${i.name}</div>
                    </div>
                    <button class="btn-circle-sains" onclick="moveToSains(${i.id})">S</button>
                    <button class="btn-pill ${isDone ? 'active' : ''}" onclick="toggleAldiDone(${i.id})">${isDone ? '‚úî Got it' : 'Got it'}</button>
                </div>`;
            });
            html += `</div>`;
        };
        needed.forEach(item => {
            const key = `${item.aisle}-${item.side}`;
            if(key !== currentAisleKey) { flushGroup(); currentAisleKey = key; itemsInGroup = []; }
            itemsInGroup.push(item);
        });
        flushGroup();
        document.getElementById('list-aldi').innerHTML = html;
    }
    function renderSains() {
        const list = items.filter(i => (i.status === 'sains' || i.status === 'done_sains') && i.qty > 0);
        if(!list.length) { document.getElementById('list-sains').innerHTML = '<div class="empty-msg">No items here.</div>'; return; }
        list.sort((a,b) => {
            if(a.aisle !== b.aisle) return a.aisle - b.aisle;
            if(a.side !== b.side) return a.side.localeCompare(b.side);
            return a.order - b.order;
        });
        let html = '';
        list.forEach(i => {
            const isDone = (i.status === 'done_sains');
            html += `
            <div class="item-row ${isDone ? 'is-done' : ''}">
                <div class="item-info">
                    <div class="item-name"><strong>(${i.qty})</strong> ${i.name}</div>
                </div>
                <button class="btn-undo" onclick="revertToAldi(${i.id})">‚Ü©Ô∏è</button>
                <button class="btn-pill ${isDone ? 'active' : ''}" onclick="toggleSainsDone(${i.id})">${isDone ? '‚úî Got it' : 'Got it'}</button>
            </div>`;
        });
        document.getElementById('list-sains').innerHTML = `<div class="aisle-card">${html}</div>`;
    }

    // --- CUSTOM SUGGESTION ENGINE ---
    function showSuggestions(txt) {
        const box = document.getElementById('suggestion-box');
        if(!txt) { box.style.display = 'none'; return; }
        
        const matches = items.filter(i => i.name.toLowerCase().includes(txt.toLowerCase()))
                             .sort((a,b) => a.name.localeCompare(b.name));
        
        if(matches.length === 0) { box.style.display = 'none'; return; }

        box.innerHTML = matches.map(i => `
            <div class="suggestion-item" onclick="selectSuggestion('${i.name}')">${i.name}</div>
        `).join('');
        box.style.display = 'block';
    }
    function selectSuggestion(name) {
        document.getElementById('rec-new-ing').value = name;
        document.getElementById('suggestion-box').style.display = 'none';
    }

    // --- MODALS ---
    let editId = null; let recEditId = null;
    function openEdit(id) {
        editId = id; const i = items.find(x => x.id === id);
        document.getElementById('edit-name').value = i.name;
        document.getElementById('edit-aisle').value = i.aisle;
        document.getElementById('edit-side').value = i.side;
        document.getElementById('edit-order').value = i.order;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; editId = null; }
    function saveEdit() {
        if(!editId) return; const i = items.find(x => x.id === editId);
        i.name = document.getElementById('edit-name').value;
        i.aisle = parseInt(document.getElementById('edit-aisle').value);
        i.side = document.getElementById('edit-side').value;
        i.order = parseInt(document.getElementById('edit-order').value);
        save(); closeModal();
    }
    function deleteItem() { if(confirm('Delete forever?')) { items = items.filter(x => x.id !== editId); save(); closeModal(); } }

    function openRecModal(id) {
        recEditId = id; const r = recipes.find(x => x.id === id);
        document.getElementById('rec-name').value = r.name;
        document.getElementById('rec-new-ing').value = '';
        document.getElementById('suggestion-box').style.display = 'none';
        renderRecIngList(r);
        document.getElementById('modal-recipe').style.display = 'flex';
    }
    function closeRecModal() { document.getElementById('modal-recipe').style.display = 'none'; saveRecipes(); renderRecipes(); }
    function deleteRecipe() { if(confirm('Delete Recipe?')) { recipes = recipes.filter(r => r.id !== recEditId); saveRecipes(); closeRecModal(); } }
    
    function addIngredientToRecipe() {
        const txt = document.getElementById('rec-new-ing').value.trim();
        if(!txt) return; const r = recipes.find(x => x.id === recEditId);
        r.ingredients.push({ name: txt, qty: 1 }); 
        document.getElementById('rec-new-ing').value = ''; 
        document.getElementById('suggestion-box').style.display = 'none';
        renderRecIngList(r);
    }
    function removeIngredient(idx) {
        const r = recipes.find(x => x.id === recEditId);
        r.ingredients.splice(idx, 1); renderRecIngList(r);
    }
    
    function updateRecIngQty(idx, change) {
        const r = recipes.find(x => x.id === recEditId);
        const ing = r.ingredients[idx];
        ing.qty = Math.max(1, ing.qty + change);
        renderRecIngList(r);
    }

    function renderRecIngList(r) {
        const div = document.getElementById('rec-ing-list');
        if(r.ingredients.length === 0) { div.innerHTML = '<div class="empty-msg">No ingredients.</div>'; return; }

        div.innerHTML = r.ingredients.map((ing, idx) => {
            return `
            <div class="rec-edit-row">
                <span style="flex-grow:1; font-weight:500;">${ing.name}</span>
                <div class="qty-control">
                    <button class="btn-mini" onclick="updateRecIngQty(${idx}, -1)">-</button>
                    <span style="width:20px; text-align:center; font-weight:bold;">${ing.qty}</span>
                    <button class="btn-mini" onclick="updateRecIngQty(${idx}, 1)">+</button>
                </div>
                <button onclick="removeIngredient(${idx})" style="color:red; border:none; background:none; margin-left:10px;">‚úï</button>
            </div>`;
        }).join('');
    }

    // Init
    go('kitchen');
</script>
</body>
</html>
